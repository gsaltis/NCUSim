var Login = {
    ControlMode: null,
    Encode64: function (e) {
        e = escape(e);
        var c = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
            b = "",
            m, k, h = "",
            l, j, g, f = "",
            d = 0,
            a = (e.length) % 3; 
        do {
            m = e.charCodeAt(d++);
            k = e.charCodeAt(d++);
            h = e.charCodeAt(d++);
            l = m >> 2;
            j = (((m << 4) | (k >> 4)) & 63);
            g = (((k << 2) | (h >> 6)) & 63);
            f = h & 63;
            b = b + c.charAt(l) + c.charAt(j) + c.charAt(g) + c.charAt(f);
            m = "";
            k = "";
            h = "";
            l = "";
            j = "";
            g = "";
            f = ""
        } while (d < e.length);
        if (a == 1) {
            m = e.charCodeAt(d++);
            l = ((m & 192) >> 2);
            j = ((m & 3) << 4);
            g = "=";
            f = "=";
            b = b + c.charAt(l) + c.charAt(j) + c.charAt(g) + c.charAt(f)
        }
        if (a == 2) {
            m = e.charCodeAt(d++);
            k = e.charCodeAt(d++);
            l = ((m & 192) >> 2);
            j = ((m & 3) << 4) | ((k & 240) >> 4);
            g = ((k & 15) << 2);
            f = "=";
            b = b + c.charAt(l) + c.charAt(j) + c.charAt(g) + c.charAt(f)
        }
        return b
    },
    Encode85: function (input){
        var it = Math.floor(input.length/4);
        var v=0;
        var i,j,k,l;
        var a,b,c,d,e;
        var output = "";
        if(Math.floor(input.length%4))
            it++;

        for(i=0,l=0; l<it; l++){
            v=0; 
            if(input.charAt(i))
                v += input.charCodeAt(i++) << 24;          
            if(input.charAt(i))
                v += input.charCodeAt(i++) << 16;
            if(input.charAt(i))
                v += input.charCodeAt(i++) << 8;
            if(input.charAt(i))
                v += input.charCodeAt(i++);            

            a = String.fromCharCode(Math.floor((v%85)+33));
            v=v/85;                       
            b = String.fromCharCode(Math.floor((v%85)+33));
            v=v/85; 
            c = String.fromCharCode(Math.floor((v%85)+33));
            v=v/85;
            d = String.fromCharCode(Math.floor((v%85)+33));
            v=v/85;
            e = String.fromCharCode(Math.floor((v%85)+33));
            v=v/85;
            output += e + d + c + b + a;          
        } 
        return output;
    },
    LoginSubmit: function() {
        var f = this;
        var b = $("#loginForm"),
            a = $("#user_name"),
            i = $("#user_password");
        var g = $("div.loginError");
        if (!a.val()) {
            //g.html(this.Errors[3]).show();
            $(".error_popup").remove();
            g.append("<div class='error_popup'><img src='../images/error4.png'></img><i>There was a problem</i><div class='error_popup_msg' id='error_popup_msg'>"+this.Errors[3]+"</div></div>").show();
            a.addClass("error");
            i.removeClass("error");
            a.focus();
            return false
        } else {
            if (a.val().length > 32) {
                //g.html(this.Errors[3]).show();
            $(".error_popup").remove();
            g.append("<div class='error_popup'><img src='../images/error4.png'></img><i>There was a problem</i><div class='error_popup_msg' id='error_popup_msg'>"+this.Errors[3]+"</div></div>").show();
                a.addClass("error");
                i.removeClass("error");
                a.focus();
                return false
            } else {
                if (!i.val()) {
                    //g.html(this.Errors[2]).show();
            $(".error_popup").remove();
            g.append("<div class='error_popup'><img src='../images/error4.png'></img><i>There was a problem</i><div class='error_popup_msg' id='error_popup_msg'>"+this.Errors[2]+"</div></div>").show();
                    if (!a.hasClass("error")) {
                        i.addClass("error")
                    }
                    i.focus();
                    return false
                }
            }
        }
        this.LoginError = false;
        if (f.ControlMode != null && f.ControlMode == 2) {
            alert(Login.HTML.control_mode);
            return
        }
        $("#language_type").val("0");
        var j = $("a.form-submit"),
            b = $("#loginForm"),
            c = encodeURIComponent(this.Encode85(a.val())),
            h = encodeURIComponent(this.Encode85(i.val())),
            e = j.text(),
            d = $.ajax({
                type: b.attr("method"),
                url: b.attr("action") + "?_=" + new Date().getTime(),
                data: "user_name=" + c + "&user_password=" + h,
                timeout: 60000,
                beforeSend: function () {
                    j.addClass("disabled").html(Login.HTML.loging)
                },
                success: function (s, l, v) {
                    var s = jQuery.evalJSON(s);
                    if (s.status == 1) {
                        var w = s.cookie.split(",");
                        for (var p = 0, x = w.length; p < x; p++) {
                            var t = w[p].split("=");
                            jQuery.cookie(t[0], t[1], {
                                path: "/"
                            })
                        }
                        jQuery.cookie("user_name", c, {
                            path: "/"
                        });
                        jQuery.cookie("user_password", h, {
                            path: "/"
                        });
                        jQuery.cookie("systeminfo", 1, {
                            path: "/"
                        });
                        var u = window.location.search.replace("?", "").split("&");
                        var o = {};
                        for (var r = 0, k = u.length; r < k; r++) {
                            var n = u[r].split("=");
                            o[n[0]] = decodeURIComponent(n[1])
                        }
                        if (o.from && o != "") {
                            location.href = o.from
                        } else {
                            var m = jQuery.cookie("loc_lang_type");
                            var y = "";
                            switch (Number(m)) {
                                case 0:
                                    y = "de";
                                    break;
                                case 1:
                                    y = "es";
                                    break;
                                case 2:
                                    y = "fr";
                                    break;
                                case 3:
                                    y = "it";
                                    break;
                                case 4:
                                    y = "ru";
                                    break;
                                case 5:
                                    y = "tr";
                                    break;
                                case 6:
                                    y = "tw";
                                    break;
                                case 7:
                                    y = "zh";
                                    break
                            }
                            var q = "index.html" + (y != "" ? "?hl=" + y : "");
                            location.href = q
                        }
                    } else {
                        if (s.status == 4) {
                            $(".error_popup").remove();
                            g.append("<div class='error_popup'><img src='../images/error4.png'></img><i>There was a problem</i><div class='error_popup_msg' id='error_popup_msg'>"+f.Errors[s.status] + " " + s.cookie+"</div></div>").show();
                        }else if(s.status == 9){   //ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Òªï¿½ï¿½×ªï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò³ï¿½æ£¬ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ãºï¿½ï¿½ï¿½Üµï¿½Â?
                            alert(f.Errors[s.status])
                            window.location.reload();
                        } else {
                            //g.html(f.Errors[s.status]).show()
                            $(".error_popup").remove();
                            g.append("<div class='error_popup'><img src='../images/error4.png'></img><i>There was a problem</i><div class='error_popup_msg' id='error_popup_msg'>"+f.Errors[s.status]+"</div></div>").show();
                        }
                        f.ClearCookie();
                        j.removeClass("disabled").html(Login.HTML.login)
                    }
                },
                error: function(k, l) {
                    //g.html(f.Errors[4] + " errCode:0").show();
                    $(".error_popup").remove();
                    g.append("<div class='error_popup'><img src='../images/error4.png'></img><i>There was a problem</i><div class='error_popup_msg' id='error_popup_msg'>"+f.Errors[4] + " errCode:0"+"</div></div>").show();
                    f.ClearCookie();
                    j.removeClass("disabled").html(Login.HTML.login)
                }
            }).done(function (k, l) {
                k = null;
                d = null
            })
    },
    LoginSubmitone: function () {
        var that = this;
        _form = $("#loginForm_one"), _name = $("#_name"), passold = $("#_oldpassword"), _password1 = $("#_password1"), _password2 = $("#_password2");
        error = $("div.loginError_one");
        //ï¿½ï¿½Ö¤ï¿½ï¿½ï¿½ë£ºÎª6Î»ï¿½ï¿½,ï¿½Ò²ï¿½ï¿½ï¿½Îªï¿½Õ£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò»ï¿½ï¿?,ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È?
        if ($.trim(passold.val()) == "") {
            error.html("Please enter old password.").show();
            passold.addClass("error");
            passold.focus();
            return false;
        }
        if ($.trim(_password1.val()) == "") {
            error.html("Please enter new password.").show();
            _password1.addClass("error");
            _password1.focus();
            return false;
        };
        if (!(/^\d{6}$/gi.test(_password1.val())) || _password1.val().length != 6) {
            error.html("Password must be six digits.").show();
            _password1.addClass("error");
            _password1.focus();
            return false;
        }
        if ($.trim(_password2.val()) == "") {
            error.html("Please confirm password.").show();
            _password2.addClass("error");
            _password2.focus();
            return false;
        };
        if (!(/^\d{6}$/gi.test(_password2.val())) || _password2.val().length != 6) {
            error.html("Password must be six digits.").show();
            _password2.addClass("error");
            _password2.focus();
            return false;
        }
        if (_password1.val() !== _password2.val()) {
            error.html("Passwords do not match.").show();
            _password2.addClass("error");
            _password2.focus();
            return false;
        }
        that.LoginError = false;
        //ï¿½á½»ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ï¢
        var name_privilege = "", btn_submitone = $("a.form-submitone");
        if (_name.attr("disabled")) {
            name_privilege = "&_name=" + _name.val() + "&_privilege=" + "4";
        }
        var XHR = $.ajax({
            url: _form.attr("action") + "?_=" + new Date().getTime(),
            type: _form.attr("method") ? _form.attr("method") : "GET",
            data: _form.serialize()+ "&_contact="+"&_privilege=" + "4" + name_privilege,
            timeout:15000,
            beforeSend: function () {
                //ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê±,disabledï¿½ï¿½Â¼ï¿½ï¿½Å¥
                btn_submitone.addClass("disabled").html(Login.HTML['Click refresh']);
            },
            success: function (data, textStatus, jqXHR) {
                try {
                    var data = jQuery.evalJSON(data);
                } catch (err) {
                    alert("Data format error.");
                    return false;
                };	
                if (data.status == 98) {
					alert("Set timeout,please refresh")
					return false;
				}else if(data.status == 12){
				   alert("Incorrect old password entered,refresh the page later")
				   setTimeout(function(){
                        window.location.reload();
                    },900);
				}else if (data.status == 1) {
                    setTimeout(function(){
                        alert("Success,update completed");
                        $("#update").fadeOut();
                        window.location.reload();
                    },900);
                }else {
                   alert("Failure,unknown error!") 
                }
            },
            error: function (data, textStatus) {
                setTimeout(function () {
                     that.LoginSubmitone();
                }, 500);
                return false;
            }
        }).done(function (textStatus, jqXHR) {
            jqXHR = null;
            XHR = null;
        });
    },
    Login: function () {
        var a = this,
            b = $("#selectLang");
        b.on("change", function () {
            var c = $(this).val();
            a.getData(c)
        });
        $(".form-submit").on("click", function () {
            if ($(this).hasClass("disabled")) {
                return
            }
            a.LoginSubmit();
            return false
        });
//        ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        $(".form-submitone").on("click", function () {
            if ($(this).hasClass("disabled")) {
                return
            }
            $("#_modify_configure_detail").val(57);
			$("#_submit").val("_modify_user");
            a.LoginSubmitone();
            return false
        });
        this.URL = $("#loginForm").attr("action")
    },
    ClearCookie: function () {
        var c = ["clientIP", "hash_key", "nAuthority", "name", "sessionId", "user_name", "user_password", "restart"];
        for (var b = 0, a = c.length; b < a; b++) {
            jQuery.removeCookie(c[b], "")
        }
    },
    Initialization: function (s) {
        var e = this;
        $(document).on("keyup", function (g) {
            if (g.keyCode == 13) {
                e.LoginSubmit();
                e.LoginSubmitone();
            }
        });
        var a = $("#ModuleLoading"),
            c = $("#LoadingContent"),
            b = $("#login");
        jQuery.cookie("cookieisok", "1", {
            path: "/"
        });
        if (jQuery.cookie("cookieisok") !== "1") {
            c.html(Login.HTML.nocookie);
            return
        } else {
            jQuery.removeCookie("cookieisok", "", {
                path: "/"
            })
        }
        var d = $("#tmp_login").html();
        f();
        function f() {
            var g = $.ajax({
                url: "/var/datas/data.login.html?_=" + new Date().getTime(),
                beforeSend: function () {
                    c.html(Login.HTML.loading)
                },
                success: function (n, l, p) {
                    var q = new RegExp('"%__data_end__%"', "g");
                    if (q.test(n)) {
                        n = n.replace('"%__data_end__%"', "")
                    } else {
                        setTimeout(function () {
                            c.html(Login.HTML.nodata)
                        }, 500);
                        return
                    }
                    var h = window.location.search.replace("?", "").split("&");
                    var m = {};
                    for (var o = 0, j = h.length; o < j; o++) {
                        var k = h[o].split("=");
                        m[k[0]] = k[1]
                    }
                    if (m.lang && m.lang != 0 || /\/loc\//gi.test(window.location.href)) {
                        jQuery.cookie("language_type", 1, {
                            path: "/"
                        })
                    } else {
                        jQuery.cookie("language_type", 0, {
                            path: "/"
                        })
                    }
                    var n = jQuery.evalJSON(n);
                    jQuery.cookie("alarmsound", n.Alarms_sound, {
                        path: "/"
                    });
                    $("#PlantLoad").text(n.Load_Current + "A");
                    $("#PlantVoltage").text(n.Voltage + "V");
                    $(".all_alarm em").text(n.AllAlarms);
                    $(".list_alarm span").eq(0).find("em").text(n.Observation);
                    $(".list_alarm span").eq(1).find("em").text(n.Major);
                    $(".list_alarm span").eq(2).find("em").text(n.Critical);
                    if (!e.running) {
                        if (n.Alarms_sound == 1) {
                            if ($("#AlmSoundOff").css("display") == "none") {
                                $("#AlmSoundOff").show();
                                $("#qnm").stop();
                                $("#qnm").css({
                                    "margin-left": $("body").width() / 2 - 150 + "px",
                                    "margin-top": window.innerHeight / 2 - 110 + "px"
                                });
                                e.running = true;
                                e.ScreenSaver(1)
                            }
                        } else {
                            $("#AlmSoundOff").hide()
                        }
                    } else {
                        if (n.Alarms_sound == 0) {
                            $("#AlmSoundOff").hide()
                        }
                    }
                    if (e.running) {
                        if (n.Alarms_sound == 1) {
                            if ($("#AlmSoundOff").css("display") == "none") {
                                $("#AlmSoundOff").show();
                                $("#qnm").stop();
                                $("#qnm").css({
                                    "margin-left": $("body").width() / 2 - 150 + "px",
                                    "margin-top": window.innerHeight / 2 - 110 + "px"
                                });
                                e.running = false;
                                e.ScreenSaver(1)
                            }
                        } else {
                            $("#AlmSoundOff").hide()
                        }
                    } else {
                        if (n.Alarms_sound == 0) {
                            $("#AlmSoundOff").hide()
                        }
                    }
                    e.ControlMode = n.control_mode;
                    d = d.replace(/\/\*\[ID_/g, "").replace(/\]\*\//g, "");
                    doTtmpl = doT.template(d);
                    doTtmp2 = doT.template($("#tmp_update").html());
//                    ï¿½Ð¶ï¿½ï¿½Ç·ï¿½Òªï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¼ï¿½ï¿?
                    if (n.Reset_password == 0) {
                        b.hide();
                        $("#update").html(doTtmp2(n)).show();
                    } else {
                        $("#update").hide();
                        b.html(doTtmpl(n)).show();     
                    }
                    if (s != "polling" && jQuery.cookie("GHMI") == "yes") {
                        e.ScreenSaver()
                    }
                    if (window.navigator.userAgent.indexOf("MSIE") >= 1) {
                        e.AddPlaceHolder()
                    }
                    a.hide();
                    e.Login();
                    $("form input").on("keydown", function () {
                        $(this).removeClass("error");
                        $("div.loginError").fadeOut();
                        $(".loginError_one").fadeOut();
                    });
                    jQuery.cookie("loc_lang_type", n.loc_lang_type, {
                        path: "/"
                    });
                    jQuery.cookie("code_mode", n.code_mode, {
                        path: "/"
                    })
                },
                error: function (h, i) {
                    $("#TipsContent").html(Login.HTML.nologindata);
                    jQuery.cookie("language_type", 0, {
                        path: "/"
                    });
                    setTimeout(function () {
                        f()
                    }, 3000);
                    return
                }
            }).always(function (h, j, i) {
                h = null;
                j = null;
                i = null;
                g = null;
                e.ClearCookie()
            })
        }
    },
    AddPlaceHolder: function () {
        (function ($) {
            var placeholderfriend = {
                focus: function (s) {
                    s = $(s).hide().prev().show().focus();
                    var idValue = s.attr("id");
                    if (idValue) {
                        s.attr("id", idValue.replace("placeholderfriend", ""))
                    }
                    var clsValue = s.attr("class");
                    if (clsValue) {
                        s.attr("class", clsValue.replace("placeholderfriend", ""))
                    }
                }
            };

            function isPlaceholer() {
                var input = document.createElement("input");
                return "placeholder" in input
            }
            if (!isPlaceholer()) {
                $(function () {
                    var form = $(this);
                    var elements = form.find("input[type='text'][placeholder]");
                    elements.each(function () {
                        var s = $(this);
                        var pValue = s.attr("placeholder");
                        var sValue = s.val();
                        if (pValue == sValue) {
                            s.addClass("phcolor")
                        }
                        if (pValue) {
                            if (sValue == "") {
                                s.val(pValue).addClass("phcolor")
                            }
                        }
                    });
                    elements.focus(function () {
                        var s = $(this);
                        var pValue = s.attr("placeholder");
                        var sValue = s.val();
                        if (sValue && pValue) {
                            if (sValue == pValue) {
                                s.val("").removeClass("phcolor")
                            }
                        }
                    });
                    elements.blur(function () {
                        var s = $(this);
                        var pValue = s.attr("placeholder");
                        var sValue = s.val();
                        if (!sValue) {
                            s.val(pValue).addClass("phcolor")
                        }
                    });
                    var elementsPass = form.find("input[type='password'][placeholder]");
                    elementsPass.each(function (i) {
                        var s = $(this);
                        var pValue = s.attr("placeholder");
                        var sValue = s.val();
                        if (pValue) {
                            if (sValue == "") {
                                var html = this.outerHTML || "";
                                html = html.replace(/\s*type=(['"])?password\1/gi, " class=phcolor type=text placeholderfriend").replace(/\s*(?:value|on[a-z]+|name)(=(['"])?\S*\1)?/gi, " ").replace(/\s*placeholderfriend/, " placeholderfriend value='" + pValue + "' onfocus='placeholderfriendfocus(this);' ");
                                var idValue = s.attr("id");
                                if (idValue) {
                                    s.attr("id", idValue + "placeholderfriend")
                                }
                                var clsValue = s.attr("class");
                                if (clsValue) {
                                    s.attr("class", clsValue + "placeholderfriend")
                                }
                                s.hide();
                                s.after(html)
                            }
                        }
                    });
                    elementsPass.blur(function () {
                        var s = $(this);
                        var sValue = s.val();
                        if (sValue == "") {
                            var idValue = s.attr("id");
                            if (idValue) {
                                s.attr("id", idValue + "placeholderfriend")
                            }
                            var clsValue = s.attr("class");
                            if (clsValue) {
                                s.attr("class", clsValue + "placeholderfriend")
                            }
                            s.hide().next().show().addClass("phcolor")
                        }
                    })
                })
            }
            window.placeholderfriendfocus = placeholderfriend.focus
        })(jQuery)
    },
    timer: null,
    showtimer: null,
    getdata: null,
    movetip: null,
    running: false,
    ScreenSaver: function (obj) {
        var that = this;
        var qnmshow = true;
        var innerheight = window.innerHeight;
        var iTime;
        $("#bzqnm").css({
            "height": innerheight + "px",
            "width": $("body").width() + "px"
        });
        $("#qnm").css({
            "margin-left": $("body").width() / 2 - 150 + "px",
            "margin-top": innerheight / 2 - 110 + "px"
        });
        document.onmousemove = document.onclick = function (event) {
            if ($("#qnm").css("display") == "block") {
                clearTimeout(iTime);
                iTime = setTimeout(function () {
                    if (that.running) {
                        if (jQuery.cookie("alarmsound") == 1) {
                            g();
                            $("#AlmSoundOff").hide()
                        } else {
                            event.preventDefault();
                            $("#qnm,#bzqnm").hide();
                            qnmshow = false;
                            that.running = false
                        }
                        bindevent(1)
                    } else {
                        $("#qnm").stop();
                        $("#qnm").css({
                            "margin-left": $("body").width() / 2 - 150 + "px",
                            "margin-top": innerheight / 2 - 110 + "px"
                        });
                        that.running = true;
                        bindevent(1, 2)
                    }
                }, 200)
            }
        };

        function bindevent(s, r) {
            clearInterval(that.getdata);
            clearInterval(that.showtimer);
            if (r == 2) {
                clearTimeout(that.movetip);
                that.running = true;
                that.movetip = setTimeout(function () {
                    that.showtimer = setInterval(movenm, 6000)
                }, 900000)
            } else {
                clearTimeout(that.timer);
                clearTimeout(that.movetip);
                that.timer = setTimeout(function () {
                    $("#bzqnm,#qnm").show();
                    that.running = true;
                    clearInterval(that.getdata);
                    that.getdata = setInterval(function () {
                        that.Initialization("polling")
                    }, 5000);
                    that.movetip = setTimeout(function () {
                        that.showtimer = setInterval(movenm, 6000)
                    }, 900000)
                }, 600000)
            }
            if ((qnmshow && s == 1) || (that.running && s == 1)) {
                that.getdata = setInterval(function () {
                    that.Initialization("polling")
                }, 5000)
            }
        }

        function movenm() {
            var bodyht = window.innerHeight;
            var bodywh = $("body").width();
            var move_x = bodywh - $("#qnm").width();
            var move_y = bodyht - $("#qnm").height();
            var nimx = Math.ceil(Math.random() * move_x);
            var nimy = Math.ceil(Math.random() * move_y);
            $("#qnm").animate({
                "margin-left": nimx + "px",
                "margin-top": nimy + "px"
            }, 2000);
            that.running = false
        }
        if (jQuery.cookie("login_timeout") == 1) {
            jQuery.cookie("login_timeout", 0, {
                path: "/"
            });
            $("#bzqnm,#qnm").show();
            that.running = true;
            that.movetip = setTimeout(function () {
                that.showtimer = setInterval(movenm, 6000)
            }, 900000);
            that.getdata = setInterval(function () {
                that.Initialization("polling")
            }, 5000)
        } else {
            if (obj == 1) {
                bindevent(1, 2)
            } else {
                bindevent(2)
            }
        }

        function g() {
            $.ajax({
                type: "POST",
                url: $("#qnm").attr("action") + "?_=" + new Date().getTime(),
                data: "control_value=0&equip_ID=1&signal_type=2&signal_id=500&value_type=5&control_type=1",
                success: function (data) {
                    jQuery.cookie("alarmsound", 0, {
                        path: "/"
                    })
                },
                error: function (data, textStatus) {
                    that.PromptEvent.Tip({
                        target: args["modules"],
                        text: Language.Html["003"] + Configs.Prompt.refresh
                    })
                }
            })
        }
    }
};